<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IP Inquiry Response System</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--ink:#1a1a2e;--ink2:#3d3d5c;--ink3:#8888a4;--ink4:#b8b8cc;--bg:#faf9f7;--bg2:#f5f3ef;--cream:#eae7e0;--acc:#9e5a2e;--acc2:#b8692f;--accl:#f5ebe3;--ok:#2d7a4f;--okb:#e8f5ef;--err:#a63d40;--errb:#fbe9ea;--bdr:#ddd8d0;--bdrl:#eae7e0;--wh:#fff;--r:10px;--rs:6px}
body{font-family:'DM Sans',-apple-system,sans-serif;background:var(--bg);color:var(--ink);min-height:100vh}
.hdr{background:var(--ink);padding:18px 32px;display:flex;align-items:center;justify-content:space-between}
.hdr-brand{display:flex;align-items:center;gap:14px}
.hdr-logo{width:38px;height:38px;border-radius:8px;background:var(--acc);display:flex;align-items:center;justify-content:center;color:#fff;font-family:'Playfair Display',serif;font-size:17px;font-weight:700}
.hdr h1{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:#f0ede8;margin:0}
.hdr-sub{font-size:11px;color:var(--ink3);font-weight:500;letter-spacing:.05em;text-transform:uppercase;margin-top:2px}
.hdr-right{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--ink3)}
.hdr-stat{display:flex;align-items:center;gap:5px}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block}.dot-ok{background:var(--ok)}.dot-off{background:var(--err)}.dot-warn{background:#d4a017}
.tabs{border-bottom:1px solid var(--bdr);background:var(--wh);padding:0 32px;display:flex;gap:4px}
.tab{padding:13px 20px;border:none;background:none;cursor:pointer;font-family:inherit;font-size:13.5px;font-weight:500;color:var(--ink3);border-bottom:2px solid transparent;transition:.2s;display:flex;align-items:center;gap:7px}
.tab:hover{color:var(--ink2)}.tab.on{font-weight:700;color:var(--ink);border-bottom-color:var(--acc)}
.tc{background:var(--cream);color:var(--ink3);font-size:10px;font-weight:700;padding:1px 7px;border-radius:10px}.tab.on .tc{background:var(--ink);color:#fff}
.wrap{padding:24px 32px;max-width:1440px;margin:0 auto}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:start}
.card{background:var(--wh);border-radius:var(--r);border:1px solid var(--bdrl);overflow:hidden;box-shadow:0 1px 3px rgba(26,26,46,.06)}
.card-h{padding:15px 20px;border-bottom:1px solid var(--bdrl);display:flex;align-items:center;justify-content:space-between}
.card-t{font-size:14px;font-weight:700;letter-spacing:.02em}.card-b{padding:16px 20px}
.btn{border:none;border-radius:var(--rs);cursor:pointer;font-family:inherit;font-weight:600;transition:.2s;display:inline-flex;align-items:center;gap:6px;font-size:13px;padding:9px 18px}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-p{background:var(--ink);color:#f0ede8}.btn-a{background:var(--acc);color:#fff}.btn-a:hover:not(:disabled){background:var(--acc2)}
.btn-s{background:var(--bg2);color:var(--ink2);border:1px solid var(--bdr)}.btn-d{background:var(--errb);color:var(--err)}
.btn-g{background:transparent;color:var(--ink3);padding:6px 12px}.btn-ok{background:var(--ok);color:#fff}
.btn-sm{padding:6px 13px;font-size:12px}.btn-lg{padding:13px 24px;font-size:15px}.btn-bl{width:100%;justify-content:center}
textarea,input[type=text],input[type=password],select{width:100%;padding:10px 14px;border:1px solid var(--bdr);border-radius:var(--rs);font-family:inherit;font-size:13px;color:var(--ink);outline:none;background:var(--wh)}
textarea:focus,input:focus,select:focus{border-color:var(--acc)}textarea{resize:vertical;line-height:1.7}
.lbl{display:block;font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.rte{border:1px solid var(--bdr);border-radius:var(--rs);min-height:180px;padding:14px 16px;font-family:inherit;font-size:13px;line-height:1.7;color:var(--ink);background:var(--wh);overflow-y:auto;outline:none;max-height:450px;word-wrap:break-word}
.rte:focus{border-color:var(--acc)}.rte:empty::before{content:attr(data-placeholder);color:var(--ink4);pointer-events:none}
.rte table{border-collapse:collapse;width:100%;margin:8px 0;font-size:12px}.rte th,.rte td{border:1px solid var(--bdr);padding:6px 10px;text-align:left}.rte th{background:var(--bg2);font-weight:600}
.rte-lg{min-height:300px}.rte-hint{font-size:10px;color:var(--ink4);margin-top:4px;font-style:italic}
.cats{display:flex;gap:6px;flex-wrap:wrap}
.cat{padding:7px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:1.5px solid var(--bdr);background:var(--wh);color:var(--ink3);transition:.2s;user-select:none}
.cat:hover{border-color:var(--acc);color:var(--acc)}.cat.on{color:#fff}
.badge{padding:2px 10px;border-radius:20px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;letter-spacing:.02em}
.b-grn{background:var(--okb);color:var(--ok);border:1px solid #b8dcc8}.b-blu{background:#e8eef6;color:#2e5a88;border:1px solid #a8c4e0}
.b-ref{background:#fef3e2;color:#92620e;border:1px solid #f0d48a}
.pill{padding:4px 11px;border-radius:16px;font-size:11px;cursor:pointer;font-weight:500;border:1px solid var(--bdr);background:var(--bg2);color:var(--ink3);display:inline-block;margin:2px}
.pill.on{background:var(--ink);color:#f0ede8;border-color:var(--ink)}
.notif{position:fixed;top:20px;right:20px;z-index:1000;padding:12px 24px;border-radius:var(--r);font-size:13px;font-weight:600;box-shadow:0 8px 30px rgba(0,0,0,.12);animation:fsi .3s}
.notif-ok{background:var(--okb);color:var(--ok)}.notif-err{background:var(--errb);color:var(--err)}
.ei{border:1px solid var(--bdrl);border-radius:var(--r);background:var(--wh);margin-bottom:8px;overflow:hidden}
.ei-h{padding:13px 20px;cursor:pointer;display:flex;align-items:center;justify-content:space-between}
.ei-pre{font-size:13px;color:var(--ink2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:5px}
.ei-arr{color:var(--ink4);font-size:18px;transition:transform .2s;margin-left:12px}.ei-arr.open{transform:rotate(180deg)}
.ei-det{border-top:1px solid var(--bdrl);padding:16px 20px}
.ecb{font-size:12px;line-height:1.7;color:var(--ink2);max-height:300px;overflow-y:auto;background:var(--bg);padding:12px;border-radius:var(--rs)}
.ecb table,.rd table{border-collapse:collapse;width:100%;margin:8px 0;font-size:12px}
.ecb th,.rd th{background:var(--ink);color:#f0ede8;padding:8px 12px;text-align:left;font-weight:600;border:1px solid var(--ink2)}
.ecb td,.rd td{border:1px solid var(--bdr);padding:7px 12px}.ecb tr:nth-child(even) td,.rd tr:nth-child(even) td{background:var(--bg)}
.rd{font-size:13px;line-height:1.8;color:var(--ink2)}.rd p{margin:4px 0}.rd strong{color:var(--ink)}
.priv{background:var(--okb);border:1px solid #b8dcc8;border-radius:var(--rs);padding:10px 16px;font-size:12px;color:var(--ok);display:flex;align-items:center;gap:8px;margin-bottom:16px}
.stat{background:var(--bg);border-radius:var(--rs);padding:16px;text-align:center}.stat-n{font-size:28px;font-weight:700}.stat-l{font-size:11px;color:var(--ink3);font-weight:600;text-transform:uppercase;margin-top:2px}
.form-hl{border:2px solid var(--acc)!important}
.setup-b{background:var(--accl);border:1px solid #dcc8ae;border-radius:var(--r);padding:20px 24px;margin-bottom:20px}.setup-b h3{font-size:15px;font-weight:700;color:var(--acc);margin-bottom:8px}
.db-ok{background:var(--okb);border:1px solid #b8dcc8;border-radius:var(--rs);padding:12px 16px;font-size:13px;color:var(--ok);display:flex;align-items:center;gap:8px}
.db-warn{background:#fef9e7;border:1px solid #f0d98a;border-radius:var(--rs);padding:12px 16px;font-size:13px;color:#856404;display:flex;align-items:center;gap:8px}
.regen-bar{background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rs);padding:12px 16px;margin-top:14px}
.regen-chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.rchip{padding:5px 12px;border-radius:16px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--bdr);background:var(--wh);color:var(--ink2);transition:.2s}
.rchip:hover{border-color:var(--acc);color:var(--acc);background:var(--accl)}
.draft-hist{margin-top:10px;border-top:1px solid var(--bdrl);padding-top:10px}
.draft-item{background:var(--bg);border:1px solid var(--bdrl);border-radius:var(--rs);padding:10px 14px;margin-bottom:6px;font-size:11px;color:var(--ink3);cursor:pointer}
.draft-item:hover{border-color:var(--acc)}.jn-row{display:flex;gap:10px;margin-bottom:10px;align-items:start}.jn-sel{min-width:160px;flex-shrink:0}
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.login-card{width:100%;max-width:420px}
.login-card .card-b{padding:28px 32px}
.login-card input{margin-bottom:14px}
.user-row{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--bdrl);border-radius:var(--rs);margin-bottom:6px;font-size:13px}
.user-row .u-name{font-weight:600;flex:1}.user-row .u-role{font-size:11px;color:var(--ink3)}
.chpw-box{background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rs);padding:14px;margin-top:12px}
@media(max-width:900px){.g2{grid-template-columns:1fr}.wrap{padding:16px}.hdr{padding:16px}.tabs{padding:0 16px;overflow-x:auto}}
@keyframes spin{to{transform:rotate(360deg)}}@keyframes fsi{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.sp{width:20px;height:20px;border:2.5px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;display:inline-block}
.sp-d{width:30px;height:30px;border:3px solid var(--bdr);border-top-color:var(--ink);border-radius:50%;animation:spin .8s linear infinite}
</style>
</head>
<body>
<div id="app">Loading...</div>
<script>
(function(){
"use strict";
var SB_URL="https://evgmwssofshotqyikhnx.supabase.co";
var SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2Z213c3NvZnNob3RxeWlraG54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNjEwMjMsImV4cCI6MjA4NjYzNzAyM30.C7u8x-BHeFGeevCobIu2IRBQnUcFi5CHFh11KN2u69o";
var JURISDICTIONS=["Saudi Arabia","UAE","Qatar","Kuwait","Bahrain","Oman","Egypt","Jordan","Lebanon","Iraq","Morocco","Tunisia","Algeria","China","Hong Kong","Taiwan","Japan","South Korea","India","Singapore","USA","UK","Germany","France","EU (EUIPO)","Spain","Italy","Turkey","Russia","Brazil","Mexico","Canada","Australia","Other"];
var TOPICS=["Assignment/Transfer","Renewal","New Filing/Application","Opposition","Cancellation","Recordal","Change of Name/Address","Licensing","Search/Clearance","Watch Service","Infringement","Domain Dispute","Copyright","Patent Filing","Design Registration","Legalization","Notarization","Power of Attorney","Other"];
var CATEGORIES=["Asian","GCC","Europe","US","Local - US","Local - Europe","Local - Asian"];
var CAT_COLORS={"Asian":"#7c3aed","GCC":"#0e7490","Europe":"#1d4ed8","US":"#b91c1c","Local - US":"#9f1239","Local - Europe":"#4338ca","Local - Asian":"#6d28d9"};
var db=null,dbOk=false;
var S={screen:"login",currentUser:null,loginErr:"",tab:"generate",entries:[],settings:{firmName:"",toneNotes:"",greeting:"Dear Colleagues,",apiKey:"",model:"claude-haiku-4-5-20251001",jurisNotes:{},feeTemplates:{}},inquiry:"",inquiryHtml:"",addNotes:"",clientCat:"",response:"",generating:false,genErr:"",copied:false,drafts:[],search:"",fJuris:"",fTopic:"",fCat:"",showForm:false,editId:null,expId:null,fInqH:"",fResH:"",fFinalH:"",fRefNum:"",fJuris2:"",fTopics:[],fNotes:"",fCat2:"",notif:null,showKey:false,dbLoading:false,setJuris:"Saudi Arabia",setFeeJuris:"Saudi Arabia",setFeeCat:"Asian",users:[],showChPw:false};

async function hashPw(pw){var enc=new TextEncoder().encode(pw);var buf=await crypto.subtle.digest("SHA-256",enc);return Array.from(new Uint8Array(buf)).map(function(b){return b.toString(16).padStart(2,"0")}).join("")}
function loadSession(){try{var s=localStorage.getItem("ip-session");if(s)S.currentUser=JSON.parse(s)}catch(x){}}
function saveSession(){try{localStorage.setItem("ip-session",JSON.stringify(S.currentUser))}catch(x){}}
function clearSession(){S.currentUser=null;try{localStorage.removeItem("ip-session")}catch(x){}}

function initDB(){try{db=window.supabase.createClient(SB_URL,SB_KEY);dbOk=true}catch(e){dbOk=false;db=null}}
async function testConnection(){if(!db)return false;try{var r=await db.from("entries").select("id").limit(1);return!r.error}catch(e){return false}}
async function loadSharedSettings(){if(!db)return;try{var r=await db.from("shared_settings").select("*").eq("id","config").single();if(r.data&&r.data.config){var c=JSON.parse(r.data.config);for(var k in c)S.settings[k]=c[k]}}catch(e){}}
async function saveSharedSettings(){if(!db)return;try{var row={id:"config",config:JSON.stringify(S.settings),updated_by:S.currentUser?S.currentUser.username:"unknown"};var r=await db.from("shared_settings").upsert(row);if(r.error)throw r.error}catch(e){notify("Save failed: "+e.message,true)}}
async function loadUsers(){if(!db)return;try{var r=await db.from("users").select("*").order("created_at",{ascending:true});if(!r.error)S.users=r.data||[]}catch(e){}}
async function doLogin(user,pw){if(!db){S.loginErr="Database unavailable";render();return}var hash=await hashPw(pw);try{var r=await db.from("users").select("*").eq("username",user.trim().toLowerCase());if(r.error)throw r.error;if(!r.data||!r.data.length){S.loginErr="Invalid username or password";render();return}var u=r.data[0];if(u.password_hash!==hash){S.loginErr="Invalid username or password";render();return}S.currentUser={username:u.username,role:u.role};S.loginErr="";saveSession();await loadSharedSettings();await loadEntries();await loadUsers();S.screen="app";render()}catch(e){S.loginErr="Error: "+e.message;render()}}
async function doCreateUser(user,pw,role){if(!db)return;var hash=await hashPw(pw);try{var r=await db.from("users").insert({username:user.trim().toLowerCase(),password_hash:hash,role:role||"user"});if(r.error)throw r.error;await loadUsers();notify("User '"+user+"' created");render()}catch(e){notify("Failed: "+e.message,true)}}
async function doDeleteUser(username){if(!db)return;try{var r=await db.from("users").delete().eq("username",username);if(r.error)throw r.error;await loadUsers();notify("User deleted");render()}catch(e){notify("Failed: "+e.message,true)}}
async function doResetPassword(username,newPw){if(!db)return;var hash=await hashPw(newPw);try{var r=await db.from("users").update({password_hash:hash}).eq("username",username);if(r.error)throw r.error;notify("Password updated for "+username)}catch(e){notify("Failed: "+e.message,true)}}
async function doChangeMyPassword(oldPw,newPw){if(!db||!S.currentUser)return;var oldHash=await hashPw(oldPw);try{var r=await db.from("users").select("*").eq("username",S.currentUser.username);if(r.error)throw r.error;if(!r.data||!r.data.length)throw new Error("User not found");if(r.data[0].password_hash!==oldHash){notify("Current password is incorrect",true);return}var newHash=await hashPw(newPw);var r2=await db.from("users").update({password_hash:newHash}).eq("username",S.currentUser.username);if(r2.error)throw r2.error;notify("Your password has been changed");S.showChPw=false;render()}catch(e){notify("Failed: "+e.message,true)}}

async function loadEntries(){if(!db){try{var e=localStorage.getItem("ip-kb-entries");if(e)S.entries=JSON.parse(e)}catch(x){}return}S.dbLoading=true;try{var r=await db.from("entries").select("*").order("created_at",{ascending:false});if(r.error)throw r.error;S.entries=(r.data||[]).map(function(r){return{id:r.id,inquiry:r.inquiry,response:r.response,finalResponse:r.final_response||"",refNum:r.ref_number||"",draftHistory:function(){try{return JSON.parse(r.draft_history||"[]")}catch(x){return[]}}(),jurisdiction:r.jurisdiction||"",topics:(r.topics||"").split(",").map(function(s){return s.trim()}).filter(Boolean),clientCat:r.client_cat||"",notes:r.notes||"",date:r.date_added||""}})}catch(e){notify("DB error: "+e.message,true)}S.dbLoading=false}
function entryToRow(en){return{id:en.id,inquiry:en.inquiry,response:en.response,final_response:en.finalResponse||"",ref_number:en.refNum||"",draft_history:JSON.stringify(en.draftHistory||[]),jurisdiction:en.jurisdiction||"",topics:(en.topics||[]).join(", "),client_cat:en.clientCat||"",notes:en.notes||"",date_added:en.date||""}}
async function dbInsert(en){if(!db)return;try{var r=await db.from("entries").insert(entryToRow(en));if(r.error)throw r.error}catch(e){notify("Save failed: "+e.message,true)}}
async function dbUpdate(en){if(!db)return;try{var r=entryToRow(en);delete r.id;var res=await db.from("entries").update(r).eq("id",en.id);if(res.error)throw res.error}catch(e){notify("Update failed: "+e.message,true)}}
async function dbDelete(id){if(!db)return;try{var r=await db.from("entries").delete().eq("id",id);if(r.error)throw r.error}catch(e){notify("Delete failed: "+e.message,true)}}
async function dbBulkInsert(ens){if(!db)return;try{var r=await db.from("entries").insert(ens.map(entryToRow));if(r.error)throw r.error}catch(e){notify("Bulk save failed: "+e.message,true)}}
async function dbClearAll(){if(!db)return;try{var r=await db.from("entries").delete().neq("id","");if(r.error)throw r.error;S.entries=[]}catch(e){notify("Clear failed: "+e.message,true)}}

function notify(msg,isErr){S.notif={m:msg,e:!!isErr};render();setTimeout(function(){S.notif=null;render()},3000)}
function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}
function strip(h){var d=document.createElement("div");d.innerHTML=h;return d.textContent||""}
function gid(){return"e"+Date.now()+Math.random().toString(36).slice(2,6)}
function detectJ(t){var lo=t.toLowerCase();for(var i=0;i<JURISDICTIONS.length;i++)if(lo.indexOf(JURISDICTIONS[i].toLowerCase())>=0)return JURISDICTIONS[i];return""}
function detectT(t){var lo=t.toLowerCase();return TOPICS.filter(function(tp){return tp.toLowerCase().split(/[\s\/]+/).some(function(w){return w.length>3&&lo.indexOf(w)>=0})})}
function detectRef(t){var m=t.match(/\b[A-Z]{1,5}\d{5,15}[A-Z]{0,4}\b/g);return m?m[0]:""}
function scoreRel(en,text){var s=0,lo=text.toLowerCase();if(en.jurisdiction&&lo.indexOf(en.jurisdiction.toLowerCase())>=0)s+=15;if(en.clientCat&&en.clientCat===S.clientCat)s+=12;(en.topics||[]).forEach(function(t){t.toLowerCase().split(/[\s\/]+/).forEach(function(w){if(w.length>3&&lo.indexOf(w)>=0)s+=6})});return s}
function html2text(html){if(!html)return"";var d=document.createElement("div");d.innerHTML=html;d.querySelectorAll("table").forEach(function(tbl){var md="\n";tbl.querySelectorAll("tr").forEach(function(tr,ri){var cells=[];tr.querySelectorAll("th,td").forEach(function(c){cells.push(c.textContent.trim())});md+="| "+cells.join(" | ")+" |\n";if(ri===0)md+="| "+cells.map(function(){return"---"}).join(" | ")+" |\n"});tbl.parentNode.replaceChild(document.createTextNode(md),tbl)});d.querySelectorAll("br").forEach(function(b){b.parentNode.replaceChild(document.createTextNode("\n"),b)});d.querySelectorAll("p,div,li").forEach(function(el){el.appendChild(document.createTextNode("\n"))});return d.textContent.replace(/\n{3,}/g,"\n\n").trim()}
function renderFmt(text){if(!text)return"";var h=esc(text).replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>");var lines=h.split("\n"),res=[],inT=false,tR=[];for(var i=0;i<lines.length;i++){var tr=lines[i].trim();if(tr.charAt(0)==="|"&&tr.charAt(tr.length-1)==="|"){if(!inT){inT=true;tR=[]}if(!/^\|[\s\-:|]+\|$/.test(tr))tR.push(tr)}else{if(inT){res.push(mkTbl(tR));inT=false}res.push(tr===""?"<br>":"<p>"+tr+"</p>")}}if(inT)res.push(mkTbl(tR));return res.join("")}
function mkTbl(rows){if(!rows.length)return"";var h="<table>";rows.forEach(function(r,i){var cells=r.split("|").slice(1,-1).map(function(c){return c.trim()});var tag=i===0?"th":"td";h+="<tr>"+cells.map(function(c){return"<"+tag+">"+c+"</"+tag+">"}).join("")+"</tr>"});return h+"</table>"}
function catBadge(c){if(!c)return"";var col=CAT_COLORS[c]||"#666";return'<span class="badge" style="background:'+col+'18;color:'+col+';border:1px solid '+col+'44">'+esc(c)+"</span>"}
function doCopyText(){if(!S.response)return;try{navigator.clipboard.writeText(S.response)}catch(e){var ta=document.createElement("textarea");ta.value=S.response;document.body.appendChild(ta);ta.select();document.execCommand("copy");document.body.removeChild(ta)}S.copied="text";render();setTimeout(function(){S.copied=false;render()},2000)}
function doCopyHtml(){if(!S.response)return;var html=renderFmt(S.response);try{var blob=new Blob([html],{type:"text/html"});var tb=new Blob([S.response],{type:"text/plain"});navigator.clipboard.write([new ClipboardItem({"text/html":blob,"text/plain":tb})])}catch(e){doCopyText();return}S.copied="html";render();setTimeout(function(){S.copied=false;render()},2000)}
function isAdmin(){return S.currentUser&&S.currentUser.role==="admin"}
async function doImport(file){var reader=new FileReader();reader.onload=async function(ev){try{var wb=XLSX.read(ev.target.result,{type:"array"});var ws=wb.Sheets[wb.SheetNames[0]];var data=XLSX.utils.sheet_to_json(ws,{defval:""});var n=0;var nw=[];var exist={};S.entries.forEach(function(e){exist[strip(e.inquiry).substring(0,80)]=1});data.forEach(function(row){var inq=String(row.Inquiry||row.inquiry||"").trim();var res=String(row.Response||row.response||"").trim();if(!inq||!res)return;if(exist[inq.substring(0,80)])return;var en={id:gid(),inquiry:esc(inq).replace(/\n/g,"<br>"),response:esc(res).replace(/\n/g,"<br>"),finalResponse:esc(String(row["Final Response"]||"").trim()).replace(/\n/g,"<br>"),refNum:String(row["Reference"]||"").trim()||detectRef(inq),draftHistory:[],jurisdiction:String(row.Jurisdiction||"").trim()||detectJ(inq),topics:String(row.Topics||"").split(",").map(function(s){return s.trim()}).filter(Boolean),clientCat:String(row["Client Category"]||"").trim(),notes:String(row.Notes||"").trim(),date:String(row.Date||new Date().toISOString().slice(0,10)).trim()};S.entries.push(en);nw.push(en);n++});if(nw.length)await dbBulkInsert(nw);notify("Imported "+n+" entries");render()}catch(err){notify("Import failed: "+err.message,true)}};reader.readAsArrayBuffer(file)}
function doExport(){var data=S.entries.map(function(e){return{"Reference":e.refNum||"","Inquiry":strip(e.inquiry),"Response":strip(e.response),"Final Response":strip(e.finalResponse||""),"Jurisdiction":e.jurisdiction||"","Topics":(e.topics||[]).join(", "),"Client Category":e.clientCat||"","Notes":e.notes||"","Date":e.date||""}});var ws=XLSX.utils.json_to_sheet(data);ws["!cols"]=[{wch:20},{wch:60},{wch:80},{wch:80},{wch:18},{wch:30},{wch:18},{wch:30},{wch:12}];var wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"KB");XLSX.writeFile(wb,"IP_Knowledge_Base.xlsx");notify("Exported")}
function doTemplate(){var data=[{"Reference":"ST22726961SA","Inquiry":"Example...","Response":"Draft...","Final Response":"Actual sent...","Jurisdiction":"Saudi Arabia","Topics":"Assignment/Transfer","Client Category":"Asian","Notes":"","Date":"2025-01-15"}];var ws=XLSX.utils.json_to_sheet(data);ws["!cols"]=[{wch:20},{wch:60},{wch:80},{wch:80},{wch:18},{wch:30},{wch:18},{wch:30},{wch:12}];var wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"KB");XLSX.writeFile(wb,"IP_KB_Template.xlsx");notify("Template downloaded")}
async function doGenerate(extraInstr){if(!S.inquiryHtml.trim()){notify("Paste an inquiry first",true);return}if(!S.settings.apiKey.trim()){notify("Admin needs to set Claude API key in Settings",true);return}if(S.response&&!extraInstr)S.drafts.push({text:S.response,time:new Date().toLocaleTimeString()});S.generating=true;S.genErr="";S.response="";render();var iqText=html2text(S.inquiryHtml);var scored=S.entries.map(function(e){return{e:e,s:scoreRel(e,iqText)}}).sort(function(a,b){return b.s-a.s}).filter(function(x){return x.s>0}).slice(0,5);var examples="";if(scored.length){examples="Relevant past examples. Match tone, format, length, fees:\n\n";scored.forEach(function(x,i){var rt=x.e.finalResponse?html2text(x.e.finalResponse):html2text(x.e.response);examples+="--- EXAMPLE "+(i+1)+" ("+(x.e.jurisdiction||"N/A")+", "+(x.e.clientCat||"N/A")+") ---\nINQUIRY:\n"+html2text(x.e.inquiry).slice(0,1500)+"\n\nRESPONSE:\n"+rt.slice(0,2500)+"\n\n"})}var catN=S.clientCat?"\nClient: \""+S.clientCat+"\" category.\n":"";var detJ=detectJ(iqText);var jN=(detJ&&S.settings.jurisNotes[detJ])?"\nJURISDICTION ("+detJ+"):\n"+S.settings.jurisNotes[detJ]+"\n":"";var fN="";if(detJ){var feeKey=detJ+"|"+(S.clientCat||"");var feeHtml=S.settings.feeTemplates[feeKey]||"";if(feeHtml){fN="\nFEES ("+detJ+(S.clientCat?" - "+S.clientCat:"")+"):\n"+html2text(feeHtml)+"\n"}else{var fallback=Object.keys(S.settings.feeTemplates).filter(function(k){return k.indexOf(detJ)===0&&S.settings.feeTemplates[k]});if(fallback.length){fN="\nAVAILABLE FEE REFERENCES FOR "+detJ+":\n";fallback.forEach(function(k){fN+=k.replace("|"," - ")+":\n"+html2text(S.settings.feeTemplates[k])+"\n\n"})}}}var rN=extraInstr?"\nADDITIONAL: "+extraInstr+"\n":"";var prompt="You are an experienced IP attorney assistant. Draft a professional response.\n\n"+(S.settings.firmName?"Firm: \""+S.settings.firmName+"\".\n":"")+(S.settings.toneNotes?"Tone: "+S.settings.toneNotes+"\n":"")+"\nGuidelines:\n- Answer each question specifically\n- Fee schedules as markdown tables\n- Professional formal tone\n- Number answers matching inquiry\n- Government fees subject to change\n- Include timelines, documents, procedures\n- Professional closing\n"+catN+jN+fN+rN+"\n"+examples+"\n--- NEW INQUIRY ---\n"+iqText+"\n"+(S.addNotes?"Instructions: "+S.addNotes+"\n":"")+(S.clientCat?"Category: "+S.clientCat+"\n":"")+"\nDraft complete response with fee tables.";try{var res=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":S.settings.apiKey.trim(),"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:S.settings.model,max_tokens:4096,messages:[{role:"user",content:prompt}]})});if(!res.ok){var ed=await res.json().catch(function(){return{}});throw new Error((ed.error&&ed.error.message)||"API error "+res.status)}var data=await res.json();var text="";if(data.content){data.content.forEach(function(b){if(b.type==="text")text+=b.text})}if(!text)throw new Error("Empty response");S.response=text}catch(e){S.genErr=e.message||"Failed"}S.generating=false;render()}
function resetForm(){S.fInqH="";S.fResH="";S.fFinalH="";S.fRefNum="";S.fJuris2="";S.fTopics=[];S.fNotes="";S.fCat2="";S.showForm=false;S.editId=null}
async function doSaveEntry(){var el1=document.getElementById("form-inq"),el2=document.getElementById("form-res"),el3=document.getElementById("form-final");var h1=el1?el1.innerHTML.trim():"",h2=el2?el2.innerHTML.trim():"",h3=el3?el3.innerHTML.trim():"";if(!strip(h1)||!strip(h2)){notify("Inquiry and response required",true);return}var txt=strip(h1);var refEl=document.getElementById("form-ref");var en={id:S.editId||gid(),inquiry:h1,response:h2,finalResponse:h3,refNum:refEl?refEl.value.trim():(S.fRefNum||detectRef(txt)),draftHistory:S.drafts.map(function(d){return{text:d.text.slice(0,500),time:d.time}}),jurisdiction:S.fJuris2||detectJ(txt),topics:S.fTopics.length?S.fTopics.slice():detectT(txt),clientCat:S.fCat2,notes:S.fNotes.trim(),date:new Date().toISOString().slice(0,10)};if(S.editId){for(var i=0;i<S.entries.length;i++){if(S.entries[i].id===S.editId){en.date=S.entries[i].date;en.draftHistory=S.entries[i].draftHistory||[];S.entries[i]=en;break}}await dbUpdate(en)}else{S.entries.push(en);await dbInsert(en)}resetForm();notify(S.editId?"Updated":"Added");render()}
async function doQuickSave(){if(!S.inquiryHtml||!S.response)return;var txt=strip(S.inquiryHtml);var en={id:gid(),inquiry:S.inquiryHtml,response:renderFmt(S.response),finalResponse:"",refNum:detectRef(txt),draftHistory:S.drafts.map(function(d){return{text:d.text.slice(0,500),time:d.time}}),jurisdiction:detectJ(txt),topics:detectT(txt),clientCat:S.clientCat,notes:"",date:new Date().toISOString().slice(0,10)};S.entries.push(en);await dbInsert(en);notify("Saved! Edit to add Final Response.")}
function getF(){return S.entries.filter(function(e){if(S.fJuris&&e.jurisdiction!==S.fJuris)return false;if(S.fTopic&&(e.topics||[]).indexOf(S.fTopic)<0)return false;if(S.fCat&&e.clientCat!==S.fCat)return false;if(S.search){var lo=S.search.toLowerCase();return(strip(e.inquiry)+" "+strip(e.response)+" "+strip(e.finalResponse||"")+" "+e.jurisdiction+" "+(e.clientCat||"")+" "+(e.refNum||"")).toLowerCase().indexOf(lo)>=0}return true})}
function uniqs(key){var s=new Set();S.entries.forEach(function(e){var v=key==="topics"?(e.topics||[]):([e[key]||""]);v.forEach(function(x){if(x)s.add(x)})});return Array.from(s).sort()}

// ==================== RENDER ====================
function render(){var app=document.getElementById("app");var h="";if(S.notif)h+='<div class="notif '+(S.notif.e?"notif-err":"notif-ok")+'">'+esc(S.notif.m)+"</div>";if(S.screen==="login"){h+=renderLogin();app.innerHTML=h;return}var apiOk=!!S.settings.apiKey.trim();h+='<div class="hdr"><div class="hdr-brand"><div class="hdr-logo">IP</div><div><h1>IP Inquiry Response System</h1><div class="hdr-sub">'+esc(S.settings.firmName||"Intellectual Property Practice")+"</div></div></div>";h+='<div class="hdr-right"><div class="hdr-stat"><span class="dot dot-ok"></span>DB</div><div class="hdr-stat"><span class="dot '+(apiOk?"dot-ok":"dot-off")+'"></span>AI</div><span style="font-weight:600">'+esc(S.currentUser?S.currentUser.username:"")+'</span><button class="btn btn-g btn-sm" data-action="logout" style="color:#aaa;font-size:11px">Logout</button></div></div>';h+='<div class="tabs"><button class="tab'+(S.tab==="generate"?" on":"")+'" data-action="tab-generate">&#10022; Draft</button><button class="tab'+(S.tab==="kb"?" on":"")+'" data-action="tab-kb">Knowledge Base <span class="tc">'+S.entries.length+'</span></button><button class="tab'+(S.tab==="settings"?" on":"")+'" data-action="tab-settings">Settings</button></div><div class="wrap">';if(S.tab==="generate")h+=renderGen(apiOk);else if(S.tab==="kb")h+=renderKB();else h+=renderSet();h+="</div>";app.innerHTML=h;bindRTE("gen-inquiry",S.inquiryHtml,function(v){S.inquiryHtml=v;S.inquiry=strip(v)});bindRTE("form-inq",S.fInqH,function(v){S.fInqH=v});bindRTE("form-res",S.fResH,function(v){S.fResH=v});bindRTE("form-final",S.fFinalH,function(v){S.fFinalH=v});var feeRteEl=document.getElementById("fee-rte");if(feeRteEl&&!feeRteEl.dataset.bound){var feeKey=S.setFeeJuris+"|"+S.setFeeCat;var feeVal=S.settings.feeTemplates[feeKey]||"";if(feeVal)feeRteEl.innerHTML=feeVal;feeRteEl.dataset.bound="1"}var fi=document.getElementById("file-imp");if(fi)fi.onchange=function(ev){if(ev.target.files[0])doImport(ev.target.files[0]);ev.target.value=""}}
function bindRTE(id,html,cb){var el=document.getElementById(id);if(!el)return;if(html&&!el.dataset.bound)el.innerHTML=html;el.dataset.bound="1";el.oninput=function(){cb(this.innerHTML)}}
function renderLogin(){return'<div class="login-wrap"><div class="login-card card"><div class="card-h" style="justify-content:center"><div style="display:flex;align-items:center;gap:10px"><div class="hdr-logo">IP</div><span class="card-t" style="font-size:16px">IP Inquiry Response System</span></div></div><div class="card-b"><div class="lbl">Username</div><input type="text" id="l-user" placeholder="Username"><div class="lbl" style="margin-top:4px">Password</div><input type="password" id="l-pass" placeholder="Password">'+(S.loginErr?'<div style="color:var(--err);font-size:12px;margin-bottom:10px">'+esc(S.loginErr)+"</div>":"")+'<button class="btn btn-a btn-bl btn-lg" data-action="do-login" style="margin-top:4px">Login</button></div></div></div>'}
function renderGen(apiOk){var det=S.inquiry?detectJ(S.inquiry):"",detT=S.inquiry?detectT(S.inquiry):[],detRef=S.inquiry?detectRef(S.inquiry):"",matchN=S.inquiry?S.entries.filter(function(e){return scoreRel(e,S.inquiry)>0}).length:0;var h="";if(!apiOk)h+='<div class="setup-b"><h3>&#9881; AI Not Configured</h3><p>Admin needs to add Claude API key in Settings tab.</p></div>';h+='<div class="priv">&#128274; <b>Privacy:</b> KB in Supabase. Only inquiry + examples sent to Claude.</div><div class="g2"><div><div class="card"><div class="card-h"><span class="card-t">Paste Client Inquiry</span>';if(S.inquiryHtml)h+='<button class="btn btn-g btn-sm" data-action="clear-inq">Clear</button>';h+='</div><div style="padding:0"><div class="rte rte-lg" id="gen-inquiry" contenteditable="true" data-placeholder="Paste the client inquiry here..."></div></div><div style="padding:6px 16px 10px"><span class="rte-hint">&#128161; Paste from Outlook / Word / Excel</span></div></div><div class="card" style="margin-top:14px"><div class="card-b"><div class="lbl">Client Category</div><div class="cats" style="margin-bottom:14px">';CATEGORIES.forEach(function(c){h+='<span class="cat'+(S.clientCat===c?" on":"")+'" data-action="set-cat" data-val="'+esc(c)+'" style="'+(S.clientCat===c?"background:"+CAT_COLORS[c]+";border-color:"+CAT_COLORS[c]:"")+'">'+esc(c)+"</span>"});h+='</div><div class="lbl">Additional Instructions</div><textarea id="add-notes" placeholder="e.g., Include rush fees" style="min-height:56px">'+esc(S.addNotes)+"</textarea></div></div>";if(S.inquiry){h+='<div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;align-items:center"><span style="font-size:11px;color:var(--ink3)">Detected:</span>';if(detRef)h+='<span class="badge b-ref">REF: '+esc(detRef)+"</span>";if(det)h+='<span class="badge b-grn">'+esc(det)+"</span>";detT.forEach(function(t){h+='<span class="badge b-blu">'+esc(t)+"</span>"});if(S.clientCat)h+=catBadge(S.clientCat);h+='<span style="font-size:11px;color:var(--ink3);margin-left:8px">'+matchN+" matching</span></div>"}h+='<button class="btn btn-a btn-lg btn-bl" style="margin-top:16px" data-action="generate"'+((!S.inquiry.trim()||S.generating)?" disabled":"")+">"+( S.generating?'<span class="sp"></span> Generating...':"&#10022; Generate Response")+"</button></div>";h+='<div><div class="card"><div class="card-h"><span class="card-t">Generated Response</span>';if(S.response)h+='<div style="display:flex;gap:6px;flex-wrap:wrap"><button class="btn btn-a btn-sm" data-action="copy-html">'+(S.copied==="html"?"&#10003; Copied!":"&#128233; Outlook")+'</button><button class="btn btn-s btn-sm" data-action="copy-text">'+(S.copied==="text"?"&#10003; Copied!":"&#128203; Text")+'</button><button class="btn btn-ok btn-sm" data-action="quick-save">&#9889; Quick Save</button><button class="btn btn-s btn-sm" data-action="save-to-kb">&#9997; Edit &amp; Save</button></div>';h+='</div><div class="card-b" style="min-height:300px;max-height:600px;overflow-y:auto">';if(S.genErr)h+='<div style="padding:14px;background:var(--errb);border-radius:var(--rs);color:var(--err);font-size:13px"><b>Error:</b> '+esc(S.genErr)+"</div>";if(S.generating)h+='<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:260px;gap:14px;color:var(--ink3)"><div class="sp-d"></div><p>Generating...</p></div>';if(!S.response&&!S.generating&&!S.genErr)h+='<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:260px;color:var(--ink4)"><div style="font-size:48px;opacity:.4">&#10022;</div><p style="margin-top:12px;font-size:14px;color:var(--ink3)">Response appears here</p></div>';if(S.response)h+='<div class="rd">'+renderFmt(S.response)+"</div>";h+="</div>";if(S.response)h+='<div class="regen-bar"><div class="lbl">&#128260; Re-generate</div><div class="regen-chips"><span class="rchip" data-action="regen" data-val="Make shorter and concise">Shorter</span><span class="rchip" data-action="regen" data-val="Add rush/urgent fees">+ Rush</span><span class="rchip" data-action="regen" data-val="More detail on documents">+ Detail</span><span class="rchip" data-action="regen" data-val="Include document checklist">+ Docs</span><span class="rchip" data-action="regen" data-val="More formal with citations">Formal</span></div><div style="display:flex;gap:8px"><input type="text" id="regen-custom" placeholder="Custom instruction..." style="flex:1"><button class="btn btn-s btn-sm" data-action="regen-custom">Go</button></div></div>';if(S.drafts.length){h+='<div class="draft-hist"><div class="lbl">&#128195; Previous Drafts ('+S.drafts.length+")</div>";S.drafts.forEach(function(d,i){h+='<div class="draft-item" data-action="restore-draft" data-val="'+i+'"><b>Draft '+(i+1)+'</b> ('+esc(d.time)+") - "+esc(strip(d.text).slice(0,120))+"...</div>"});h+="</div>"}h+="</div></div></div>";return h}
function renderKB(){var juris=uniqs("jurisdiction"),topics=uniqs("topics"),cats=uniqs("clientCat"),filtered=getF();var h='<div style="display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;align-items:center"><input type="text" id="kb-search" placeholder="Search text, ref..." value="'+esc(S.search)+'" style="flex:1;min-width:180px"><select id="kb-fjuris" style="width:auto;min-width:130px"><option value="">All Jurisdictions</option>';juris.forEach(function(j){h+='<option value="'+esc(j)+'"'+(S.fJuris===j?" selected":"")+">"+esc(j)+"</option>"});h+='</select><select id="kb-ftopic" style="width:auto;min-width:130px"><option value="">All Topics</option>';topics.forEach(function(t){h+='<option value="'+esc(t)+'"'+(S.fTopic===t?" selected":"")+">"+esc(t)+"</option>"});h+='</select><select id="kb-fcat" style="width:auto;min-width:130px"><option value="">All Categories</option>';cats.forEach(function(c){h+='<option value="'+esc(c)+'"'+(S.fCat===c?" selected":"")+">"+esc(c)+"</option>"});h+="</select></div>";h+='<div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap"><button class="btn btn-a btn-sm" data-action="show-form">+ Add</button><button class="btn btn-s btn-sm" data-action="import">Import</button><button class="btn btn-s btn-sm" data-action="export"'+(S.entries.length?"":' disabled')+'>Export</button><button class="btn btn-g btn-sm" data-action="template">Template</button><button class="btn btn-s btn-sm" data-action="refresh-kb" style="margin-left:auto">&#8635; Refresh</button><input type="file" id="file-imp" accept=".xlsx,.xls,.csv" style="display:none"></div>';h+='<p style="font-size:12px;color:var(--ink3);margin-bottom:14px">'+filtered.length+"/"+S.entries.length;if(S.fJuris||S.fTopic||S.fCat||S.search)h+=' <span data-action="clear-filters" style="color:var(--acc);cursor:pointer;font-weight:600">Clear</span>';h+="</p>";if(S.showForm)h+=renderForm();if(!filtered.length&&!S.showForm)h+='<div style="text-align:center;padding:60px;color:var(--ink3)"><p>'+(S.entries.length?"No matches.":"No entries yet.")+"</p></div>";filtered.forEach(function(en){var pt=strip(en.inquiry).slice(0,140);var hasFin=en.finalResponse&&strip(en.finalResponse);h+='<div class="ei"><div class="ei-h" data-action="toggle-entry" data-id="'+en.id+'"><div style="flex:1;min-width:0"><div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:4px">';if(en.refNum)h+='<span class="badge b-ref">'+esc(en.refNum)+"</span>";if(en.jurisdiction)h+='<span class="badge b-grn">'+esc(en.jurisdiction)+"</span>";(en.topics||[]).slice(0,2).forEach(function(t){h+='<span class="badge b-blu">'+esc(t)+"</span>"});if(en.clientCat)h+=catBadge(en.clientCat);if(!hasFin)h+='<span class="badge" style="background:var(--errb);color:var(--err);border:1px solid #f0b8b9;font-size:10px">No final</span>';h+='<span style="font-size:10px;color:var(--ink4)">'+esc(en.date||"")+"</span></div><div class='ei-pre'>"+esc(pt)+"</div></div><span class='ei-arr"+(S.expId===en.id?" open":"")+"'>&#9662;</span></div>";if(S.expId===en.id){h+='<div class="ei-det"><div class="g2" style="gap:16px"><div><div class="lbl">Inquiry</div><div class="ecb">'+en.inquiry+'</div></div><div><div class="lbl">AI Draft</div><div class="ecb">'+en.response+"</div></div></div>";if(hasFin)h+='<div style="margin-top:12px"><div class="lbl" style="color:var(--acc)">&#11088; Final Response</div><div class="ecb" style="border-left:3px solid var(--acc)">'+en.finalResponse+"</div></div>";if(en.draftHistory&&en.draftHistory.length){h+='<div style="margin-top:10px"><div class="lbl">Drafts ('+en.draftHistory.length+")</div>";en.draftHistory.forEach(function(d,i){h+='<div class="draft-item"><b>'+(i+1)+"</b> ("+esc(d.time)+") - "+esc(d.text.slice(0,150))+"...</div>"});h+="</div>"}h+='<div style="margin-top:14px;display:flex;gap:8px"><button class="btn btn-s btn-sm" data-action="edit-entry" data-id="'+en.id+'">Edit</button><button class="btn btn-d btn-sm" data-action="del-entry" data-id="'+en.id+'">Delete</button></div></div>'}h+="</div>"});return h}
function renderForm(){var h='<div class="card form-hl" style="margin-bottom:20px"><div class="card-h"><span class="card-t">'+(S.editId?"Edit":"Add")+'</span><button class="btn btn-g btn-sm" data-action="cancel-form">&#10005;</button></div><div class="card-b"><div style="margin-bottom:14px"><div class="lbl">Reference</div><input type="text" id="form-ref" placeholder="ST22726961SA" value="'+esc(S.fRefNum)+'"></div><div class="g2" style="gap:16px"><div><div class="lbl">Inquiry *</div><div class="rte" id="form-inq" contenteditable="true" data-placeholder="Paste inquiry..."></div></div><div><div class="lbl">AI Draft *</div><div class="rte" id="form-res" contenteditable="true" data-placeholder="AI draft..."></div></div></div><div style="margin-top:16px"><div class="lbl" style="color:var(--acc)">&#11088; Final Response Sent</div><div class="rte" id="form-final" contenteditable="true" data-placeholder="Paste ACTUAL response sent..."></div><div class="rte-hint" style="color:var(--acc)">AI learns from this</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px"><div><div class="lbl">Jurisdiction</div><select id="form-juris"><option value="">Auto-detect</option>';JURISDICTIONS.forEach(function(j){h+='<option value="'+esc(j)+'"'+(S.fJuris2===j?" selected":"")+">"+esc(j)+"</option>"});h+='</select></div><div><div class="lbl">Category</div><div class="cats">';CATEGORIES.forEach(function(c){h+='<span class="cat'+(S.fCat2===c?" on":"")+'" data-action="form-cat" data-val="'+esc(c)+'" style="'+(S.fCat2===c?"background:"+CAT_COLORS[c]+";border-color:"+CAT_COLORS[c]:"")+'">'+esc(c)+"</span>"});h+="</div></div></div>";h+='<div style="margin-top:16px"><div class="lbl">Topics</div><div style="display:flex;gap:4px;flex-wrap:wrap">';TOPICS.forEach(function(t){h+='<span class="pill'+(S.fTopics.indexOf(t)>=0?" on":"")+'" data-action="form-topic" data-val="'+esc(t)+'">'+esc(t)+"</span>"});h+='</div></div><div style="margin-top:16px"><div class="lbl">Notes</div><input type="text" id="form-notes" value="'+esc(S.fNotes)+'"></div><div style="margin-top:18px;display:flex;gap:8px"><button class="btn btn-a" data-action="save-entry">'+(S.editId?"Update":"Add")+'</button><button class="btn btn-s" data-action="cancel-form">Cancel</button></div></div></div>';return h}
function renderSet(){var juris=uniqs("jurisdiction"),cats=uniqs("clientCat");var adm=isAdmin();var h='<div style="max-width:720px">';if(adm){h+='<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">&#128273; AI Configuration</span></div><div class="card-b"><div class="lbl">Claude API Key (shared with team)</div><div style="display:flex;gap:8px;margin-bottom:14px"><input type="'+(S.showKey?"text":"password")+'" id="api-key" placeholder="sk-ant-..." value="'+esc(S.settings.apiKey)+'" style="flex:1"><button class="btn btn-s btn-sm" data-action="toggle-key">'+(S.showKey?"&#128274;":"&#128065;")+'</button></div><div class="lbl">Model</div><select id="set-model" style="width:auto;min-width:280px;margin-bottom:14px">';[["claude-haiku-4-5-20251001","Haiku 4.5 (~$0.005)"],["claude-sonnet-4-5-20250929","Sonnet 4.5 (~$0.03)"],["claude-opus-4-5-20251101","Opus 4.5 (~$0.05)"]].forEach(function(m){h+='<option value="'+m[0]+'"'+(S.settings.model===m[0]?" selected":"")+">"+m[1]+"</option>"});h+="</select></div></div>"}else{h+='<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">&#128273; AI</span></div><div class="card-b"><p style="font-size:13px">AI: '+(S.settings.apiKey?"&#9989; Configured":"&#10060; Not set")+" | Model: "+esc(S.settings.model)+'</p><p style="font-size:11px;color:var(--ink3);margin-top:6px">Only admin can change.</p></div></div>'}if(adm){h+='<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">Firm Settings</span></div><div class="card-b"><div style="margin-bottom:16px"><div class="lbl">Firm Name</div><input type="text" id="set-firm" value="'+esc(S.settings.firmName)+'"></div><div style="margin-bottom:16px"><div class="lbl">Tone &amp; Style</div><textarea id="set-tone" style="min-height:80px">'+esc(S.settings.toneNotes)+'</textarea></div><div style="margin-bottom:16px"><div class="lbl">Greeting</div><input type="text" id="set-greet" value="'+esc(S.settings.greeting)+'"></div><button class="btn btn-a" data-action="save-settings">Save All Settings</button></div></div>'}else{h+='<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">Firm</span></div><div class="card-b"><p style="font-size:13px">'+esc(S.settings.firmName||"Not set")+'</p><p style="font-size:11px;color:var(--ink3);margin-top:6px">Only admin can edit.</p></div></div>'}h+='<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">&#127760; Jurisdiction Notes</span></div><div class="card-b"><p style="font-size:12px;color:var(--ink3);margin-bottom:12px">Auto-included in AI prompt per jurisdiction.</p><div class="jn-row"><div class="jn-sel"><select id="jn-juris">';JURISDICTIONS.forEach(function(j){h+='<option value="'+esc(j)+'"'+(S.setJuris===j?" selected":"")+">"+esc(j)+"</option>"});h+='</select></div><div style="flex:1"><textarea id="jn-text" rows="4" placeholder="e.g., Assignment needs Apostille...">'+esc(S.settings.jurisNotes[S.setJuris]||"")+'</textarea></div></div><button class="btn btn-s btn-sm" data-action="save-jnote">Save for '+esc(S.setJuris)+"</button>";var jnK=Object.keys(S.settings.jurisNotes).filter(function(k){return S.settings.jurisNotes[k]});if(jnK.length){h+='<div style="margin-top:12px;display:flex;gap:4px;flex-wrap:wrap">';jnK.forEach(function(k){h+='<span class="badge b-grn" style="cursor:pointer" data-action="load-jnote" data-val="'+esc(k)+'">'+esc(k)+"</span>"});h+="</div>"}h+="</div></div>";h+='<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">&#128176; Fee Templates</span></div><div class="card-b"><p style="font-size:12px;color:var(--ink3);margin-bottom:12px">Fee schedules per jurisdiction + client category. Paste from Excel/Word.</p><div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap"><div class="jn-sel"><div class="lbl">Jurisdiction</div><select id="fee-juris">';JURISDICTIONS.forEach(function(j){h+='<option value="'+esc(j)+'"'+(S.setFeeJuris===j?" selected":"")+">"+esc(j)+"</option>"});h+='</select></div><div class="jn-sel"><div class="lbl">Client Category</div><select id="fee-cat">';CATEGORIES.forEach(function(c){h+='<option value="'+esc(c)+'"'+(S.setFeeCat===c?" selected":"")+">"+esc(c)+"</option>"});h+='</select></div></div><div class="lbl">Fee Schedule <span style="font-weight:400;text-transform:none;font-size:10px;color:var(--ink4)">(paste tables from Excel/Word)</span></div><div class="rte" id="fee-rte" contenteditable="true" data-placeholder="Paste fee table from Excel or Word here..." style="min-height:140px;max-height:350px">'+(S.settings.feeTemplates[S.setFeeJuris+"|"+S.setFeeCat]||"")+'</div><div style="margin-top:10px;display:flex;gap:8px;align-items:center"><button class="btn btn-s btn-sm" data-action="save-fee">Save for '+esc(S.setFeeJuris)+" &mdash; "+esc(S.setFeeCat)+'</button></div>';var fK=Object.keys(S.settings.feeTemplates).filter(function(k){return S.settings.feeTemplates[k]});if(fK.length){h+='<div style="margin-top:12px"><div class="lbl">Saved Templates</div><div style="display:flex;gap:4px;flex-wrap:wrap">';fK.forEach(function(k){var parts=k.split("|");var label=(parts[0]||"")+" \u2022 "+(parts[1]||"");h+='<span class="badge b-grn" style="cursor:pointer" data-action="load-fee" data-val="'+esc(k)+'">'+esc(label)+"</span>"});h+="</div></div>"}h+="</div></div>";
  // User management
  if(adm){h+='<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">&#128101; User Management</span></div><div class="card-b"><div class="lbl">Team Members</div>';S.users.forEach(function(u){h+='<div class="user-row"><span class="u-name">'+esc(u.username)+'</span><span class="u-role" style="background:'+(u.role==="admin"?"var(--accl)":"var(--bg2)")+';padding:2px 8px;border-radius:10px">'+esc(u.role)+"</span>";if(u.username!==S.currentUser.username)h+='<button class="btn btn-g btn-sm" data-action="reset-pw" data-val="'+esc(u.username)+'" title="Reset password">&#128272;</button><button class="btn btn-d btn-sm" data-action="del-user" data-val="'+esc(u.username)+'" title="Delete">&#10005;</button>';h+="</div>"});h+='<div style="margin-top:18px;padding-top:14px;border-top:1px solid var(--bdrl)"><div class="lbl">Add New User</div><div style="display:flex;gap:8px;flex-wrap:wrap"><input type="text" id="nu-user" placeholder="Username" style="flex:1;min-width:120px"><input type="password" id="nu-pass" placeholder="Password" style="flex:1;min-width:120px"><select id="nu-role" style="width:auto;min-width:100px"><option value="user">User</option><option value="admin">Admin</option></select><button class="btn btn-ok btn-sm" data-action="add-user">Add User</button></div></div></div></div>'}
  // Change own password
  h+='<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">&#128272; Change My Password</span></div><div class="card-b">';
  if(S.showChPw){h+='<div class="lbl">Current Password</div><input type="password" id="chpw-old" placeholder="Current password" style="margin-bottom:10px"><div class="lbl">New Password</div><input type="password" id="chpw-new" placeholder="New password" style="margin-bottom:10px"><div class="lbl">Confirm New Password</div><input type="password" id="chpw-confirm" placeholder="Confirm" style="margin-bottom:14px"><div style="display:flex;gap:8px"><button class="btn btn-a btn-sm" data-action="do-chpw">Change Password</button><button class="btn btn-s btn-sm" data-action="cancel-chpw">Cancel</button></div>'}
  else{h+='<button class="btn btn-s" data-action="show-chpw">Change Password</button>'}
  h+="</div></div>";
  // Stats
  h+='<div class="card"><div class="card-h"><span class="card-t">Stats</span></div><div class="card-b"><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px"><div class="stat"><div class="stat-n">'+S.entries.length+'</div><div class="stat-l">Entries</div></div><div class="stat"><div class="stat-n">'+juris.length+'</div><div class="stat-l">Jurisdictions</div></div><div class="stat"><div class="stat-n">'+uniqs("topics").length+'</div><div class="stat-l">Topics</div></div><div class="stat"><div class="stat-n">'+cats.length+'</div><div class="stat-l">Categories</div></div></div>';var fc=S.entries.filter(function(e){return e.finalResponse&&strip(e.finalResponse)}).length;h+='<div style="margin-bottom:16px;padding:12px;background:var(--bg);border-radius:var(--rs);font-size:12px">&#11088; <b>'+fc+"/"+S.entries.length+"</b> with Final Responses</div>";if(adm)h+='<div style="padding-top:18px;border-top:1px solid var(--bdrl)"><button class="btn btn-d btn-sm" data-action="clear-all">Clear All Entries</button></div>';h+="</div></div></div>";return h}

// ===== EVENTS =====
document.addEventListener("click",function(ev){var el=ev.target.closest("[data-action]");if(!el)return;var action=el.dataset.action,val=el.dataset.val||"",id=el.dataset.id||"";switch(action){case"do-login":var lu=document.getElementById("l-user"),lp=document.getElementById("l-pass");if(lu&&lp&&lu.value.trim()&&lp.value.trim())doLogin(lu.value,lp.value);else{S.loginErr="Enter username and password";render()}break;case"logout":clearSession();S.screen="login";S.loginErr="";render();break;case"tab-generate":S.tab="generate";render();break;case"tab-kb":S.tab="kb";render();break;case"tab-settings":S.tab="settings";render();break;case"clear-inq":S.inquiry="";S.inquiryHtml="";S.response="";S.genErr="";S.drafts=[];render();break;case"set-cat":S.clientCat=(S.clientCat===val?"":val);render();break;case"generate":doGenerate();break;case"copy-text":doCopyText();break;case"copy-html":doCopyHtml();break;case"quick-save":doQuickSave();break;case"save-to-kb":if(!S.inquiryHtml||!S.response)break;S.fInqH=S.inquiryHtml;S.fResH=renderFmt(S.response);S.fFinalH="";S.fRefNum=detectRef(S.inquiry);S.fJuris2=detectJ(S.inquiry);S.fTopics=detectT(S.inquiry);S.fCat2=S.clientCat;S.showForm=true;S.tab="kb";render();window.scrollTo(0,0);break;case"regen":doGenerate(val);break;case"regen-custom":var rc=document.getElementById("regen-custom");if(rc&&rc.value.trim())doGenerate(rc.value.trim());break;case"restore-draft":var di=parseInt(val);if(S.drafts[di]){S.response=S.drafts[di].text;render()}break;case"show-form":resetForm();S.showForm=true;render();window.scrollTo(0,0);break;case"import":var fi=document.getElementById("file-imp");if(fi)fi.click();break;case"export":doExport();break;case"template":doTemplate();break;case"clear-filters":S.search="";S.fJuris="";S.fTopic="";S.fCat="";render();break;case"toggle-entry":S.expId=(S.expId===id?null:id);render();break;case"edit-entry":var en=S.entries.find(function(e){return e.id===id});if(!en)break;S.fInqH=en.inquiry;S.fResH=en.response;S.fFinalH=en.finalResponse||"";S.fRefNum=en.refNum||"";S.fJuris2=en.jurisdiction||"";S.fTopics=(en.topics||[]).slice();S.fNotes=en.notes||"";S.fCat2=en.clientCat||"";S.editId=id;S.showForm=true;render();window.scrollTo(0,0);break;case"del-entry":if(!confirm("Delete?"))break;S.entries=S.entries.filter(function(e){return e.id!==id});dbDelete(id);notify("Deleted");render();break;case"cancel-form":resetForm();render();break;case"form-cat":S.fCat2=(S.fCat2===val?"":val);render();break;case"form-topic":var idx=S.fTopics.indexOf(val);if(idx>=0)S.fTopics.splice(idx,1);else S.fTopics.push(val);render();break;case"save-entry":var nEl=document.getElementById("form-notes");if(nEl)S.fNotes=nEl.value;var jEl=document.getElementById("form-juris");if(jEl)S.fJuris2=jEl.value;doSaveEntry();break;case"save-settings":var k=document.getElementById("api-key");if(k)S.settings.apiKey=k.value;var f=document.getElementById("set-firm");if(f)S.settings.firmName=f.value;var t=document.getElementById("set-tone");if(t)S.settings.toneNotes=t.value;var g=document.getElementById("set-greet");if(g)S.settings.greeting=g.value;var mo=document.getElementById("set-model");if(mo)S.settings.model=mo.value;saveSharedSettings().then(function(){notify("All settings saved");render()});break;case"toggle-key":S.showKey=!S.showKey;render();break;case"clear-all":if(!confirm("DELETE ALL ENTRIES?"))break;dbClearAll().then(function(){notify("Cleared");render()});break;case"refresh-kb":loadEntries().then(function(){notify("Refreshed");render()});break;case"save-jnote":var jt=document.getElementById("jn-text");if(jt)S.settings.jurisNotes[S.setJuris]=jt.value;saveSharedSettings().then(function(){notify("Saved for "+S.setJuris);render()});break;case"load-jnote":S.setJuris=val;render();break;case"save-fee":var fRte=document.getElementById("fee-rte");if(fRte){var feeKey=S.setFeeJuris+"|"+S.setFeeCat;S.settings.feeTemplates[feeKey]=fRte.innerHTML}saveSharedSettings().then(function(){notify("Saved for "+S.setFeeJuris+" \u2014 "+S.setFeeCat);render()});break;case"load-fee":var fp=val.split("|");S.setFeeJuris=fp[0]||"Saudi Arabia";S.setFeeCat=fp[1]||"Asian";render();break;case"add-user":var nu=document.getElementById("nu-user"),np=document.getElementById("nu-pass"),nr=document.getElementById("nu-role");if(nu&&np&&nu.value.trim()&&np.value.trim())doCreateUser(nu.value,np.value,nr?nr.value:"user");else notify("Username and password required",true);break;case"del-user":if(confirm("Delete user '"+val+"'?"))doDeleteUser(val);break;case"reset-pw":var newPw=prompt("New password for "+val+":");if(newPw&&newPw.trim())doResetPassword(val,newPw.trim());break;case"show-chpw":S.showChPw=true;render();break;case"cancel-chpw":S.showChPw=false;render();break;case"do-chpw":var co=document.getElementById("chpw-old"),cn=document.getElementById("chpw-new"),cc=document.getElementById("chpw-confirm");if(!co||!cn||!cc||!co.value||!cn.value){notify("Fill all fields",true);break}if(cn.value!==cc.value){notify("Passwords don't match",true);break}if(cn.value.length<6){notify("Password must be at least 6 characters",true);break}doChangeMyPassword(co.value,cn.value);break}});
document.addEventListener("input",function(ev){var id=ev.target.id;if(id==="kb-search"){S.search=ev.target.value;render()}else if(id==="add-notes"){S.addNotes=ev.target.value}});
document.addEventListener("change",function(ev){var id=ev.target.id;if(id==="kb-fjuris"){S.fJuris=ev.target.value;render()}else if(id==="kb-ftopic"){S.fTopic=ev.target.value;render()}else if(id==="kb-fcat"){S.fCat=ev.target.value;render()}else if(id==="jn-juris"){S.setJuris=ev.target.value;render()}else if(id==="fee-juris"){S.setFeeJuris=ev.target.value;render()}else if(id==="fee-cat"){S.setFeeCat=ev.target.value;render()}});
document.addEventListener("keydown",function(ev){if(ev.key==="Enter"&&S.screen==="login"){var btn=document.querySelector('[data-action="do-login"]');if(btn)btn.click()}});

// ===== INIT =====
loadSession();initDB();
if(db){testConnection().then(function(ok){if(ok){dbOk=true;if(S.currentUser){loadSharedSettings().then(function(){return loadEntries()}).then(function(){return loadUsers()}).then(function(){S.screen="app";render()})}else{S.screen="login";render()}}else{S.screen="login";S.loginErr="Database connection failed";render()}})}
else{S.screen="login";S.loginErr="Database unavailable";render()}
})();
</script>
</body>
</html>
